#!/bin/bash

# Get the currently logged-in user
loggedInUser=$(stat -f%Su /dev/console)

# Prompt for admin username
adminUser=$(osascript -e 'Tell application "System Events" to display dialog "Enter admin username:" default answer "" with hidden answer buttons {"OK"} default button 1' -e 'text returned of result')

# Prompt for admin password
adminPass=$(osascript -e 'Tell application "System Events" to display dialog "Enter admin password:" default answer "" with hidden answer buttons {"OK"} default button 1 with hidden answer' -e 'text returned of result')

# Prompt for user password
userPass=$(osascript -e 'Tell application "System Events" to display dialog "Enter your Mac password:" default answer "" with hidden answer buttons {"OK"} default button 1 with hidden answer' -e 'text returned of result')

# Grant Secure Token
grantOutput=$(sysadminctl -adminUser "$adminUser" -adminPassword "$adminPass" -secureTokenOn "$loggedInUser" -password "$userPass" 2>&1)

# Check result and notify
if echo "$grantOutput" | grep -q "Done"; then
    osascript -e 'display dialog "Secure Token successfully granted!" buttons {"OK"} default button 1'
else
    osascript -e 'display dialog "Failed to grant Secure Token. Please contact IT." buttons {"OK"} default button 1'
fi